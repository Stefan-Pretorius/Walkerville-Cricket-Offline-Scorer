<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pumas Scorer Pro v3.57 (Wicket Edit & Run Outs)</title>
    <style>
        :root {
            --primary: #1a73e8; --secondary: #fbbc04; --wicket: #d93025;
            --boundary: #1e8e3e; --field: #673ab7; --bg: #f1f3f4;
            --wide: #0288d1; --nb: #e64a19; --bye: #7b1fa2;
            --btn-std: #607d8b; --btn-run: #2e7d32; --btn-4: #ef6c00;
            --inn1-color: #1a73e8; --inn2-color: #fbbc04;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 10px; padding-bottom: 50px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        .setup-layout { max-width: 800px; margin: 20px auto; }
        .team-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        textarea { width: 100%; height: 200px; padding: 12px; border-radius: 8px; border: 1px solid #ccc; resize: none; font-family: inherit; font-size: 0.9rem; }
        
        .scoring-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .scorecard-header h1 { font-size: 3.5rem; color: var(--primary); text-align: center; margin: 0; }
        .header-details { display: flex; justify-content: space-around; background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 10px; font-weight: bold; }
        .target-ui { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; padding: 5px 10px; border-radius: 4px; }
        .target-ui.passed { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
        .editable { cursor: pointer; border-bottom: 1px dashed #999; }
        .editable:hover { color: var(--primary); border-bottom: 1px solid var(--primary); }

        .batter-stats { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; margin: 15px 0; align-items: center; }
        .player-card { background: white; border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; border: 2px solid #eee; }
        .player-card.active { border-color: var(--primary); background: #e8f0fe; }
        .balls-left-badge { font-size: 0.75rem; background: #eee; padding: 3px 6px; border-radius: 4px; margin-top: 5px; display: inline-block; font-weight: bold; }
        .balls-left-badge.alert { background: var(--wicket); color: white; animation: pulse 1.5s infinite; }

        #btn-swap-center {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: var(--secondary); color: white; font-weight: bold; font-size: 1.2rem;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
        }

        .controls-grid-new { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .run-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .extra-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .admin-row { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        
        button { padding: 14px; border-radius: 10px; border: 1px solid #ddd; font-weight: bold; cursor: pointer; font-size: 1rem; transition: all 0.2s; }
        button:active { transform: scale(0.96); }

        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-secondary { background: var(--secondary); border: none; }
        .btn-danger { background: var(--wicket); color: white; border: none; }
        .btn-save { background: #333; color: white; border: none; }

        .btn-run { background: white; color: #333; border: 1px solid #ccc; font-size: 1.1rem; }
        .btn-wide { background: var(--wide); color: white; border: none; }
        .btn-nb { background: var(--nb); color: white; border: none; }
        .btn-bye { background: var(--bye); color: white; border: none; }
        .btn-wicket { background: var(--wicket); color: white; border: none; }
        .btn-retire { background: #607d8b; color: white; border: none; }

        .controls.pending-mode .btn-wide,
        .controls.pending-mode .btn-nb,
        .controls.pending-mode .btn-bye,
        .controls.pending-mode .btn-wicket,
        .controls.pending-mode .btn-retire,
        .controls.pending-mode .btn-map {
            opacity: 0.3; pointer-events: none;
        }
        .controls.pending-mode .btn-run { border: 2px solid var(--primary); background: #e8f0fe; }

        #helper-container {
            display: none; margin-bottom: 10px; background: #fff3e0;
            padding: 10px; border-radius: 8px; border: 1px solid #ffe0b2;
            align-items: center; justify-content: space-between;
        }
        #helper-text { font-weight: bold; color: #e65100; font-size: 1rem; }
        #btn-cancel-pending {
            background: #d93025; color: white; border: none; 
            padding: 8px 15px; border-radius: 6px; font-size: 0.9rem; cursor: pointer;
        }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 5000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 500px; text-align: center; max-height: 95vh; overflow-y: auto; }
        .large-modal { width: 95%; max-width: 1000px; text-align: left; }
        .modal select, .modal input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; }

        .field-container { width: 280px; height: 280px; margin: 0 auto; position: relative; }
        .cricket-field { width: 100%; height: 100%; background: #4CAF50; border-radius: 50%; border: 4px solid white; position: relative; }
        .pitch { position: absolute; width: 20px; height: 60px; background: #f0e68c; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .zone { position: absolute; width: 36px; height: 36px; background: rgba(255,255,255,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: bold; cursor: pointer; border: 1px solid #333; z-index: 100; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        th { background: #f8f9fa; padding: 8px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        
        .history-sidebar { height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        .history-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.8rem; }
        .history-item strong { color: var(--primary); }
        .history-ball-num { font-family: 'Courier New', monospace; background: #333; color: white; padding: 2px 5px; border-radius: 4px; font-weight: bold; margin-right: 5px; font-size: 0.75rem; }
        .fow-container { margin-top: 15px; border-top: 2px solid #ddd; padding-top: 10px; }
        .fow-title { font-weight: bold; color: var(--wicket); margin-bottom: 5px; font-size: 0.9rem; }
        .fow-item { font-size: 0.8rem; color: #555; padding: 2px 0; }
        
        #save-indicator { position: fixed; bottom: 10px; right: 10px; background: #333; color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; opacity: 0; transition: opacity 0.5s; }
        
        .toggle-switch { display: inline-flex; align-items: center; gap: 10px; font-size: 0.9rem; cursor: pointer; }
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }

        .chart-container { margin-top: 20px; padding: 10px; border: 1px solid #eee; border-radius: 8px; }
        .bar-chart { display: flex; align-items: flex-end; height: 150px; gap: 4px; padding-top: 20px; }
        .bar-group { flex: 1; display: flex; gap: 1px; height: 100%; align-items: flex-end; }
        .bar { flex: 1; min-width: 3px; border-radius: 2px 2px 0 0; position: relative; }
        .bar:hover::after { content: attr(data-val); position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; background: #333; color: white; padding: 2px 4px; border-radius: 3px; }
        
        .collapsible { background-color: #f1f1f1; cursor: pointer; padding: 12px; width: 100%; border: none; text-align: left; outline: none; font-size: 1rem; border-radius: 8px; margin-bottom: 5px; font-weight: bold; }
        .active-coll, .collapsible:hover { background-color: #ccc; }
        .coll-content { padding: 0 10px; display: block; overflow: hidden; background-color: white; border-radius: 0 0 8px 8px; transition: max-height 0.2s ease-out; }

        @media print {
            body * { visibility: hidden; }
            #report-modal, #report-modal * { visibility: visible; }
            #report-modal { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: white; color: black; padding: 0; box-shadow: none; display: block !important; }
            .modal-content { width: 100%; max-width: 100%; border: none; padding: 0; }
            .log-container { max-height: none !important; overflow: visible !important; border: none !important; }
            .report-section { page-break-inside: avoid; margin-bottom: 20px; }
            .no-print { display: none !important; }
            .result-banner { -webkit-print-color-adjust: exact; }
            .report-header { -webkit-print-color-adjust: exact; background-color: #eee !important; }
        }
    </style>
</head>
<body>
    <div id="app" class="main-container">
        <div id="setup-screen" class="card setup-layout">
            <h2 style="color:var(--primary); text-align:center;">Match Registration</h2>
            <div id="innings-notice" style="background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:15px; display:none;"></div>
            <div class="team-grid">
                <div><label><strong>Batting Team</strong></label><textarea id="bat-list" placeholder="Names (One per line)"></textarea><p id="c1" style="font-size:0.8rem; color:#666;">0 Players</p></div>
                <div><label><strong>Bowling Team</strong></label><textarea id="bowl-list" placeholder="Names (One per line)"></textarea><p id="c2" style="font-size:0.8rem; color:#666;">0 Players</p></div>
            </div>
            <div class="config-row" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <div><label>Max Overs</label><input type="number" id="match-overs" value="28"></div>
                <div><label>Stage</label><input type="text" id="innings-display" value="1st Innings" readonly></div>
            </div>
            <button class="btn-primary" onclick="startGame()" style="width:100%">Start Innings</button>
            <input type="file" id="import-file" style="display:none" onchange="importState(event)">
            <button onclick="document.getElementById('import-file').click()" class="btn-secondary" style="width:100%; margin-top:10px;">üìÇ Import Save</button>
        </div>

        <div id="scoring-screen" class="scoring-grid" style="display:none;">
            <div class="left-col">
                <header class="scorecard-header card">
                    <h1 id="total-display">0 / 0</h1>
                    <div class="header-details">
                        <p>Ov: <span id="overs-display">0.0</span></p>
                        <p>Bowl: <strong id="cur-bowler-display" class="editable" onclick="openManualSwap('bowler')">--</strong></p>
                        <p id="target-box" style="display:none" class="target-ui">Target: <span id="target-val">--</span></p>
                        <p>Proj: <strong id="projected-display">--</strong></p>
                    </div>
                </header>

                <div class="batter-stats">
                    <div id="striker-box" class="player-card active">
                        <div><strong id="striker-name" class="editable" onclick="openManualSwap('striker')">--</strong>*<br><div id="striker-badge" class="balls-left-badge">--</div></div>
                        <div style="font-size:1.5rem"><span id="striker-runs">0</span>(<span id="striker-balls">0</span>)</div>
                    </div>
                    <button id="btn-swap-center" onclick="manualSwapStrike()" title="Swap Strike">‚áÑ</button>
                    <div id="ns-box" class="player-card">
                        <div><span id="ns-name" class="editable" onclick="openManualSwap('ns')">--</span><br><div id="ns-badge" class="balls-left-badge">--</div></div>
                        <div style="font-size:1.5rem"><span id="ns-runs">0</span>(<span id="ns-balls">0</span>)</div>
                    </div>
                </div>

                <button type="button" class="collapsible active-coll" onclick="toggleGraph()">üìà Live Worm Graph</button>
                <div id="live-chart-content" class="coll-content" style="display:block;">
                    <div id="live-chart-ui"></div>
                </div>

                <div class="controls card" id="controls-area" style="margin-top:10px;">
                    <div id="helper-container" style="display:none;">
                        <span id="helper-text">SELECT RUNS</span>
                        <button id="btn-cancel-pending" onclick="cancelPending()">Cancel ‚úï</button>
                    </div>

                    <div class="controls-grid-new">
                        <div class="run-row">
                            <button class="btn-run" id="btn-run-0" onclick="handleInput(0)">.</button>
                            <button class="btn-run" onclick="handleInput(1)">1</button>
                            <button class="btn-run" onclick="handleInput(2)">2</button>
                            <button class="btn-run" onclick="handleInput(3)">3</button>
                            <button class="btn-run" style="border-color:var(--boundary); color:var(--boundary);" onclick="handleInput(4)">4</button>
                            <button class="btn-run" style="border-color:var(--boundary); color:var(--boundary);" onclick="handleInput(6)">6</button>
                            <button class="btn-run" onclick="handleCustomInput()">5+</button>
                        </div>
                        <div class="extra-row">
                            <button onclick="setPendingMode('wide')" class="btn-wide">Wide</button>
                            <button onclick="setPendingMode('noball')" class="btn-nb">No Ball</button>
                            <button onclick="setPendingMode('byes')" class="btn-bye">Bye</button>
                            <button onclick="setPendingMode('legbye')" class="btn-bye">Leg Bye</button>
                        </div>
                        <div class="admin-row">
                            <button onclick="openWicketModal()" class="btn-wicket">WICKET</button>
                            <button onclick="openRetireModal()" class="btn-retire">Retire</button>
                        </div>
                        <div class="admin-row">
                            <button onclick="undo()" class="btn-run">Undo</button>
                            <button onclick="openFieldModal()" style="background:var(--field); color:white;" class="btn-map">Map</button>
                        </div>
                    </div>

                    <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                        <label class="toggle-switch">
                            <div class="switch">
                                <input type="checkbox" id="map-toggle" checked>
                                <span class="slider"></span>
                            </div>
                            Show Map on Runs
                        </label>
                    </div>
                </div>

                <div class="card">
                    <table id="batter-table"><thead><tr><th>Name</th><th>R</th><th>B</th><th>4s</th><th>Status</th></tr></thead><tbody></tbody></table>
                    <button onclick="openTeamManager()" class="btn-secondary" style="width:100%; margin-top:10px; font-size:0.8rem; padding:8px;">‚úèÔ∏è Manage Team Names</button>
                    <table id="bowler-table" style="margin-top:20px;"><thead><tr><th>Bowler</th><th>O</th><th>R</th><th>W</th><th>Econ</th></tr></thead><tbody></tbody></table>
                </div>

                <div style="display:flex; gap:10px;">
                    <button onclick="swapInnings()" class="btn-secondary" style="flex:1">Swap</button>
                    <button onclick="generateReport()" class="btn-primary" style="flex:1">üìä Report</button>
                    <button onclick="saveMatch()" class="btn-save" style="flex:1">Save</button>
                    <button onclick="exportState()" style="flex:1">Export</button>
                    <button onclick="resetMatch()" class="btn-danger" style="flex:1">Reset</button>
                </div>
            </div>
            <div class="history-sidebar card">
                <h3>Ball History</h3>
                <div id="ball-list-ui"></div>
                <div class="fow-container">
                    <div class="fow-title">Fall of Wickets</div>
                    <div id="fow-ui"></div>
                </div>
            </div>
        </div>

        <div id="report-modal" class="modal"><div class="modal-content large-modal">
            <h2 id="report-title" style="text-align:center">Match Report</h2>
            <div id="report-content"></div>
            <div class="no-print" style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-primary" onclick="window.print()" style="flex:1">Print / Save PDF</button>
                <button class="btn-secondary" onclick="closeModals()" style="flex:1">Close</button>
            </div>
        </div></div>

        <div id="next-batter-modal" class="modal"><div class="modal-content"><h3>Select Incoming Batter</h3><p>The previous striker is Out/Retired. Please select who is coming in next.</p><select id="sel-next-bat-fix"></select><button class="btn-primary" onclick="confirmNextBatterFix()" style="width:100%">Confirm</button></div></div>

        <div id="wicket-modal" class="modal"><div class="modal-content">
            <h3>Wicket!</h3>
            <p>Dismissed Player:</p><select id="wkt-who"><option value="striker">Striker (Facing)</option><option value="ns">Non-Striker</option></select>
            <p>Type:</p><select id="wkt-type"><option value="Bowled">Bowled</option><option value="Caught">Caught</option><option value="LBW">LBW</option><option value="Run Out">Run Out</option><option value="Stumped">Stumped</option></select>
            <p>Runs Completed (if Run Out):</p><input type="number" id="wkt-runs" value="0" min="0">
            <p>Fielder:</p><select id="wkt-fielder"><option value="">-- None/Bowler --</option></select>
            <p>Next Batter:</p><select id="sel-next-bat"></select>
            <button class="btn-primary" onclick="confirmWicket()" style="width:100%; margin-bottom:10px;">Confirm</button>
            <button class="btn-secondary" onclick="closeModals()" style="width:100%">Cancel</button>
        </div></div>

        <div id="edit-history-modal" class="modal"><div class="modal-content">
            <h3>Edit Ball/Wicket</h3>
            <label>Runs:</label> <input type="number" id="edit-runs">
            <label>Type:</label>
            <select id="edit-type"><option value="normal">Normal</option><option value="wide">Wide</option><option value="noball">No Ball</option><option value="byes">Byes</option><option value="legbye">Leg Byes</option><option value="wicket">Wicket</option></select>
            
            <div id="edit-wkt-fields" style="display:none; background:#fee; padding:10px; border-radius:5px; margin-top:5px;">
                <label>Wicket Type:</label><select id="edit-wkt-type"><option value="Bowled">Bowled</option><option value="Caught">Caught</option><option value="Run Out">Run Out</option><option value="LBW">LBW</option><option value="Stumped">Stumped</option></select>
                <label>Out Player:</label><select id="edit-wkt-out"></select>
            </div>

            <label>Batter:</label><select id="edit-batter"></select>
            <label>Bowler:</label><select id="edit-bowler"></select>
            <input type="hidden" id="edit-index">
            <button class="btn-primary" onclick="confirmEditBall()" style="width:100%; margin-bottom:10px;">Save Changes</button>
            <button class="btn-secondary" onclick="closeModals()" style="width:100%">Cancel</button>
        </div></div>

        <div id="team-manager-modal" class="modal"><div class="modal-content"><h3>Manage Teams</h3><div class="team-grid"><div><label>Team 1</label><textarea id="edit-team1-list"></textarea></div><div><label>Team 2</label><textarea id="edit-team2-list"></textarea></div></div><button class="btn-primary" onclick="confirmTeamEdit()" style="width:100%">Save Changes</button><button class="btn-secondary" onclick="closeModals()" style="width:100%; margin-top:10px;">Cancel</button></div></div>
        <div id="bowler-modal" class="modal"><div class="modal-content"><h3>New Over</h3><p>Select Bowler:</p><select id="sel-bowler"></select><button class="btn-primary" onclick="confirmBowler()" style="width:100%">Start Over</button></div></div>
        <div id="retire-modal" class="modal"><div class="modal-content"><h3>Retire Batter</h3><p>Select Incoming Batter:</p><select id="sel-retire-next"></select><button class="btn-primary" onclick="confirmRetire()" style="width:100%">Confirm Retire</button><button class="btn-secondary" onclick="closeModals()" style="width:100%; margin-top:10px;">Cancel</button></div></div>
        <div id="swap-modal" class="modal"><div class="modal-content"><h3>Change Player</h3><select id="sel-swap"></select><input type="hidden" id="swap-role"><button class="btn-primary" onclick="confirmSwap()" style="width:100%">Update</button><button class="btn-secondary" onclick="closeModals()" style="width:100%; margin-top:10px;">Cancel</button></div></div>
        <div id="edit-event-modal" class="modal"><div class="modal-content"><h3>Edit Event</h3><select id="edit-event-name"></select><input type="hidden" id="edit-event-index"><button class="btn-primary" onclick="confirmEditEvent()" style="width:100%">Save Changes</button><button class="btn-secondary" onclick="closeModals()" style="width:100%; margin-top:10px;">Cancel</button></div></div>
        <div id="field-modal" class="modal"><div class="modal-content"><h3>Zone</h3><div class="field-container"><div class="cricket-field"><div class="zone" onclick="selectZone('Third Man')" style="top:10%; left:20%;">TM</div><div class="zone" onclick="selectZone('Fine Leg')" style="top:10%; left:65%;">FL</div><div class="zone" onclick="selectZone('Point')" style="top:40%; left:5%;">P</div><div class="zone" onclick="selectZone('Cover')" style="top:65%; left:15%;">C</div><div class="zone" onclick="selectZone('Mid Off')" style="top:85%; left:35%;">MO</div><div class="zone" onclick="selectZone('Mid On')" style="top:85%; left:60%;">MN</div><div class="zone" onclick="selectZone('Mid Wicket')" style="top:65%; left:80%;">MW</div><div class="zone" onclick="selectZone('Square Leg')" style="top:40%; left:88%;">SL</div><div class="pitch"></div></div></div></div></div>
        <div id="save-indicator">Saved ‚úì</div>
    </div>

    <script>
        let match = { innings: 1, target: null, t1: [], t2: [], count1: 13, count2: 13, overs: 28 };
        let live = { runs: 0, wkts: 0, ov: 0, balls: 0, striker: "", ns: "", bowler: "", history: [], batters: {}, bowlers: {}, retireLimit: 13, gameOver: false, promptedOvers: [], pendingExtra: null };
        const rLimits = { 8: 21, 9: 18, 10: 16, 11: 15, 12: 14, 13: 13 };

        document.getElementById('bat-list').addEventListener('input', () => {
            const n = document.getElementById('bat-list').value.split('\n').filter(x => x.trim()).length;
            document.getElementById('c1').innerText = n + " Players";
        });
        document.getElementById('bowl-list').addEventListener('input', () => {
            const n = document.getElementById('bowl-list').value.split('\n').filter(x => x.trim()).length;
            document.getElementById('c2').innerText = n + " Players";
        });

        function startGame() {
            const b = document.getElementById('bat-list').value.split('\n').map(x => x.trim()).filter(x => x);
            const bo = document.getElementById('bowl-list').value.split('\n').map(x => x.trim()).filter(x => x);
            if (b.length < 2 || bo.length < 1) return alert("Registration Incomplete!");
            match.overs = parseInt(document.getElementById('match-overs').value);
            if (match.innings === 1) { match.t1 = b; match.t2 = bo; match.count1 = b.length; match.count2 = bo.length; }
            else { match.t2 = b; match.t1 = bo; match.count2 = b.length; }
            if(match.innings === 1) live.history = [];
            live.retireLimit = rLimits[b.length] || 13; live.batters = {}; live.gameOver = false;
            b.forEach((n, i) => live.batters[n] = { name: n, runs: 0, balls: 0, 4:0, status: 'Yet to bat', stint: 1, order: i });
            live.striker = b[0]; live.ns = b[1];
            live.batters[live.striker].status = 'Active'; live.batters[live.ns].status = 'Active';
            live.bowlers = {};
            bo.forEach(n => live.bowlers[n] = { name: n, runs: 0, wkts: 0, balls: 0 });
            live.bowler = bo[0];
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('scoring-screen').style.display = 'grid';
            openBowlerModal(); 
            recalc();
        }

        function handleInput(runs) {
            if (live.pendingExtra) resolveExtra(live.pendingExtra, runs);
            else handleBall(runs, 'normal');
        }

        function handleCustomInput() {
            let val = prompt("Enter runs scored:");
            if (val === null || val === "") return;
            let runs = parseInt(val);
            if (isNaN(runs) || runs < 0) return alert("Invalid number");
            handleInput(runs);
        }

        function setPendingMode(type) {
            live.pendingExtra = type;
            document.getElementById('controls-area').classList.add('pending-mode');
            const helperContainer = document.getElementById('helper-container');
            const helperText = document.getElementById('helper-text');
            const btnRun0 = document.getElementById('btn-run-0');
            helperContainer.style.display = 'flex';
            let label = "";
            if (type === 'wide') { label = "WIDE"; btnRun0.innerText = "0"; btnRun0.style.visibility = "visible"; }
            else if (type === 'noball') { label = "NO BALL"; btnRun0.innerText = "0"; btnRun0.style.visibility = "visible"; }
            else if (type === 'byes') { label = "BYES"; btnRun0.style.visibility = "hidden"; }
            else if (type === 'legbye') { label = "LEG BYES"; btnRun0.style.visibility = "hidden"; }
            helperText.innerText = `SELECT RUNS OFF THE ${label}`;
        }

        function cancelPending() { live.pendingExtra = null; resetPendingUI(); }
        function resetPendingUI() {
            document.getElementById('controls-area').classList.remove('pending-mode');
            document.getElementById('helper-container').style.display = 'none';
            const btnRun0 = document.getElementById('btn-run-0');
            btnRun0.innerText = "."; btnRun0.style.visibility = "visible";
        }

        function resolveExtra(type, ranRuns) {
            let total = ranRuns;
            if (type === 'wide') total += 1;
            if (type === 'noball') total += 1;
            handleBall(total, type);
            live.pendingExtra = null;
            resetPendingUI();
        }

        function handleBall(r, type, wkt = null) {
            if (live.gameOver) return alert("Match Ended. Please view report.");
            if (live.ov >= match.overs) { alert("Innings Complete. Please Swap Innings."); return; }
            let isLegal = ['normal','wicket','byes','legbye'].includes(type);
            live.history.push({ event: 'ball', innings: match.innings, runs: r, type, batter: live.striker, bowler: live.bowler, legal: isLegal, wkt });
            recalc();
            const mapOn = document.getElementById('map-toggle').checked;
            if (mapOn && r > 0 && ['normal','wicket'].includes(type)) openFieldModal();
        }

        function recalc() {
            live.runs = 0; live.wkts = 0; live.ov = 0; live.balls = 0;
            live.batters = {}; live.bowlers = {};
            live.promptedOvers = []; 
            
            const battingTeam = match.innings === 1 ? match.t1 : match.t2;
            const bowlingTeam = match.innings === 1 ? match.t2 : match.t1;
            
            battingTeam.forEach((n, i) => live.batters[n] = { name: n, runs: 0, balls: 0, 4:0, status: 'Yet to bat', stint: 1, returnLimit: null, order: i });
            bowlingTeam.forEach(n => live.bowlers[n] = { name: n, runs: 0, wkts: 0, balls: 0 });

            let s = battingTeam[0], ns = battingTeam[1];
            if(live.batters[s]) live.batters[s].status = 'Active';
            if(live.batters[ns]) live.batters[ns].status = 'Active';

            let phys = 0, lastBowler = "", overEnded = false;
            let fow = [];
            live.bowler = bowlingTeam[0]; 

            live.history.forEach((h, i) => {
                const evInnings = h.innings || 1; 
                if (evInnings !== match.innings) return; 

                if (h.event === 'new_over') { live.bowler = h.name; return; }
                if (h.event === 'ball') live.bowler = h.bowler; 

                if (h.event === 'swap') { [s, ns] = [ns, s]; return; }
                if (h.event === 'replace') { 
                    let oldName = (h.role === 'striker') ? s : ns;
                    if (h.role !== 'bowler' && live.batters[oldName]) {
                        if (live.batters[oldName].balls === 0) live.batters[oldName].status = 'Yet to bat';
                    }
                    if (h.role === 'striker') { s = h.name; if(live.batters[s]) live.batters[s].status = 'Active'; }
                    if (h.role === 'ns') { ns = h.name; if(live.batters[ns]) live.batters[ns].status = 'Active'; }
                    if (h.role === 'bowler') live.bowler = h.name;
                    return; 
                }
                if (h.event === 'retire') { if (live.batters[h.name]) live.batters[h.name].status = 'Retired'; return; }
                if (h.event === 'new_bat') { 
                    if (live.batters[h.name]) {
                        if (live.batters[h.name].status === 'Retired') {
                            live.batters[h.name].stint++;
                            live.batters[h.name].returnLimit = (live.batters[h.name].stint === 2) ? live.ov + 5 : null;
                        }
                        live.batters[h.name].status = 'Active';
                    }
                    s = h.name; return; 
                }

                live.runs += (h.runs || 0);
                if (h.wkt) {
                    live.wkts++;
                    let outName = "";
                    if(h.wkt.outPlayer && live.batters[h.wkt.outPlayer]) { live.batters[h.wkt.outPlayer].status = 'Out'; outName = h.wkt.outPlayer; } 
                    else if(live.batters[s]) { live.batters[s].status = 'Out'; outName = s; }
                    fow.push(`${live.wkts}-${live.runs} (${outName}, ${live.ov}.${live.balls})`);
                }

                let isLast = (live.ov === match.overs - 1);
                if (!live.batters[h.batter]) live.batters[h.batter] = { name: h.batter, runs: 0, balls: 0, 4:0, status: 'Active', stint: 1, returnLimit: null, order: 99 };
                
                if (live.batters[h.batter]) {
                    if (!isLast) live.batters[h.batter].balls++;
                    else if (h.legal) live.batters[h.batter].balls++;
                    
                    if (['normal','wicket'].includes(h.type)) live.batters[h.batter].runs += (h.runs || 0);
                    else if (h.type === 'noball') { let offBat = (h.runs || 0) - 1; if(offBat > 0) live.batters[h.batter].runs += offBat; }
                    if (h.runs === 4) live.batters[h.batter][4]++;
                    else if (h.type === 'noball' && h.runs === 5) live.batters[h.batter][4]++;
                }

                if (live.bowlers[h.bowler]) {
                    live.bowlers[h.bowler].runs += (h.runs || 0);
                    if (h.wkt) live.bowlers[h.bowler].wkts++;
                    if (!isLast) live.bowlers[h.bowler].balls++;
                    else if (h.legal) live.bowlers[h.bowler].balls++;
                }

                phys++; let end = false;
                if (!isLast) { live.balls++; if (live.balls >= 6) end = true; } 
                else { if (h.legal) live.balls++; if (live.balls >= 6 || phys >= 8) end = true; }

                let shouldSwap = false;
                let isPenalty = ['wide','noball'].includes(h.type);
                if (isPenalty) { let ran = (h.runs || 0) - 1; if (ran % 2 !== 0) shouldSwap = true; } 
                else { if ((h.runs || 0) % 2 !== 0) shouldSwap = true; }
                if (shouldSwap) [s, ns] = [ns, s];

                if (end) {
                    if (isLast && phys >= 8 && live.balls < 6) { let diff = 6 - live.balls; if(live.bowlers[h.bowler]) live.bowlers[h.bowler].balls += diff; live.balls = 6; }
                    live.ov++; live.balls = 0; phys = 0; [s, ns] = [ns, s]; lastBowler = h.bowler;
                    if (i === live.history.length - 1 && !live.gameOver) overEnded = true;
                }
            });

            live.striker = s; live.ns = ns;
            
            if(live.batters[s]) live.batters[s].status = 'Active';
            if(live.batters[ns]) live.batters[ns].status = 'Active';

            const fowUI = document.getElementById('fow-ui');
            if(fowUI) fowUI.innerHTML = fow.map(f => `<div class="fow-item">${f}</div>`).join('');
            updateUI();
            
            if ((live.batters[live.striker].status === 'Out' || live.batters[live.striker].status === 'Retired') && !live.gameOver) {
                openNextBatterModal();
            }

            const totalBatters = battingTeam.length;
            if (live.wkts >= totalBatters - 1) {
                if (match.innings === 1 && !live.gameOver) { if(confirm("All Out! Innings Over. Swap?")) swapInnings(); } 
                else if (match.innings === 2 && !live.gameOver) { if(confirm("All Out! Match Complete. View Report?")) generateReport(); live.gameOver = true; }
            } else if (live.ov >= match.overs && !live.gameOver) {
                if (match.innings === 1) if(confirm("Overs Complete. Swap?")) swapInnings();
                if (match.innings === 2) { if(confirm("Match Complete (Overs). View Report?")) generateReport(); live.gameOver = true; }
            }

            if (overEnded && !live.gameOver && document.getElementById('scoring-screen').style.display !== 'none') {
                if (live.bowler === lastBowler) { setTimeout(openBowlerModal, 200); }
            }
            checkRetire(live.batters[s]);
            saveToMemory();
        }

        function updateUI() {
            document.getElementById('total-display').innerText = live.runs + " / " + live.wkts;
            let dispOv = live.ov; let dispBalls = live.balls;
            if(live.ov >= match.overs && live.balls === 0) { dispOv = match.overs; dispBalls = 0; }
            document.getElementById('overs-display').innerText = dispOv + "." + dispBalls;
            document.getElementById('cur-bowler-display').innerText = live.bowler;
            document.getElementById('striker-name').innerText = live.striker;
            document.getElementById('ns-name').innerText = live.ns;
            
            const bGone = (live.ov * 6) + live.balls;
            const rr = bGone > 0 ? (live.runs / (bGone/6)).toFixed(2) : "0.00";
            let projText = "";
            if (match.innings === 1) projText = Math.round(live.runs + (rr * ((match.overs*6 - bGone)/6)));
            else {
                if (live.runs >= match.target) { projText = "WIN!"; document.getElementById('target-box').classList.add('passed'); document.getElementById('target-val').innerText = "Passed"; } 
                else { const need = match.target - live.runs; projText = `Need ${need}`; document.getElementById('target-val').innerText = match.target; }
            }
            document.getElementById('projected-display').innerText = projText;
            updatePlayerCard('striker', live.batters[live.striker]);
            updatePlayerCard('ns', live.batters[live.ns]);
            
            document.querySelector('#batter-table tbody').innerHTML = Object.values(live.batters).map(p => `<tr><td>${p.name}</td><td>${p.runs}</td><td>${p.balls}</td><td>${p[4]}</td><td>${p.status}</td></tr>`).join('');
            document.querySelector('#bowler-table tbody').innerHTML = Object.values(live.bowlers).map(b => {
                let ov = Math.floor(b.balls/6) + "." + (b.balls%6);
                let econ = b.balls > 0 ? (b.runs/(b.balls/6)).toFixed(2) : "0.00";
                return `<tr><td>${b.name}</td><td>${ov}</td><td>${b.runs}</td><td>${b.wkts}</td><td>${econ}</td></tr>`;
            }).join('');
            
            let historyWithLabels = [];
            let h_ov = 0, h_b = 0, h_phys = 0;
            live.history.forEach((h, idx) => {
                if (h.innings !== match.innings) return;
                if (h.event === 'ball') {
                     let label = `${h_ov}.${h_b + 1}`;
                     historyWithLabels.push({...h, label: label, originalIndex: idx});
                     let isLast = (h_ov === match.overs - 1);
                     let end = false; h_phys++;
                     if (!isLast) { h_b++; if (h_b >= 6) end = true; } else { if (h.legal) h_b++; if (h_b >= 6 || h_phys >= 8) end = true; }
                     if (end) { h_ov++; h_b = 0; h_phys = 0; }
                } else historyWithLabels.push({...h, label: "", originalIndex: idx});
            });

            document.getElementById('ball-list-ui').innerHTML = historyWithLabels.reverse().map(h => {
                if (h.event !== 'ball') return ''; 
                let numBadge = `<span class="history-ball-num">${h.label}</span>`;
                let desc = `${numBadge} <span style="color:#666">${h.bowler} to ${h.batter}</span>: <strong>${h.runs}</strong> (${h.type})`;
                if (h.wkt) desc = `${numBadge} <span style="color:red; font-weight:bold;">WKT (${h.bowler} to ${h.batter}): ${h.wkt.type}</span>`;
                return `<div class="history-item" onclick="openEditModal(${h.originalIndex})">${desc} ${h.zone ? '['+h.zone.substring(0,3)+']' : ''}</div>`;
            }).join('');
            renderLiveGraph();
        }

        function renderLiveGraph() {
            const evts1 = live.history.filter(h => ((h.innings === 1) || (!h.innings && match.innings === 1)) && h.event === 'ball');
            const evts2 = live.history.filter(h => ((h.innings === 2) || (!h.innings && match.innings === 2)) && h.event === 'ball');
            let buildPts = (evts) => {
                let pts = "0,150 "; let cum = 0; let ov = 0; let b = 0; let phys = 0; let wktDots = "";
                let maxScore1 = evts1.reduce((acc, x) => acc + (x.runs || 0), 0);
                let maxScore2 = evts2.reduce((acc, x) => acc + (x.runs || 0), 0);
                let totalMax = Math.max(match.target || 0, maxScore1, maxScore2, 50);
                let xStep = 100 / Math.max(1, match.overs); 
                evts.forEach((h, i) => {
                    let r = h.runs || 0; cum += r;
                    let isLast = (ov === match.overs - 1); phys++; let end = false;
                    if (!isLast) { b++; if (b >= 6) end = true; } else { if (h.legal) b++; if (b >= 6 || phys >= 8) end = true; }
                    let progressInOver = isLast ? (phys/8) : (b/6); 
                    let x = (ov * xStep) + (progressInOver * xStep);
                    let y = 150 - ((cum / totalMax) * 150); 
                    pts += `${x},${y} `;
                    if(h.wkt) wktDots += `<circle cx="${x}" cy="${y}" r="2" fill="red" />`;
                    if (end) { ov++; b = 0; phys = 0; }
                });
                return {line: pts, dots: wktDots};
            };
            const d1 = buildPts(evts1); const d2 = buildPts(evts2);
            document.getElementById('live-chart-ui').innerHTML = `
            <svg width="100%" height="150" viewBox="0 0 100 150" preserveAspectRatio="none" style="border:1px solid #eee; background:#fff;">
                <polyline points="${d1.line}" fill="none" stroke="var(--inn1-color)" stroke-width="2" />
                <polyline points="${d2.line}" fill="none" stroke="var(--inn2-color)" stroke-width="2" />
                ${d1.dots} ${d2.dots}
            </svg>`;
        }

        function toggleGraph() { const c = document.getElementById("live-chart-content"); c.style.display = c.style.display === "block" ? "none" : "block"; }
        function updatePlayerCard(id, p) {
            if (!p) return;
            document.getElementById(id + '-runs').innerText = p.runs;
            document.getElementById(id + '-balls').innerText = p.balls;
            const b = document.getElementById(id + '-badge');
            if (p.stint === 2) { const left = p.returnLimit - live.ov; b.innerText = `Return: ${left}ov`; b.className = left <= 0 ? "balls-left-badge alert" : "balls-left-badge"; } 
            else { const left = live.retireLimit - p.balls; b.innerText = `Limit: ${left}`; b.className = left <= 0 ? "balls-left-badge alert" : "balls-left-badge"; }
        }

        function generateReport() {
            function getInningsStats(innNum) {
                const bTeam = innNum === 1 ? match.t1 : match.t2; const fieldTeam = innNum === 1 ? match.t2 : match.t1;
                let stats = { batters: {}, bowlers: {}, score:0, wkts:0, ov:0, balls:0, history:[], runRateData: [], fow: [] };
                bTeam.forEach(n => stats.batters[n] = { name: n, runs:0, balls:0, status:'DNB' }); fieldTeam.forEach(n => stats.bowlers[n] = { name: n, runs:0, wkts:0, balls:0 });
                const evts = live.history.filter(h => (h.innings === innNum) || (!h.innings && match.innings === innNum));
                let phys = 0, overRuns = 0, cumRuns = 0;
                evts.forEach(h => {
                    if (h.event !== 'ball') return;
                    stats.history.push(h); let r = h.runs || 0; stats.score += r; overRuns += r; cumRuns += r;
                    if(h.wkt) { stats.wkts++; const out = h.wkt.outPlayer || h.batter; if(stats.batters[out]) stats.batters[out].status = 'Out'; stats.fow.push({ score: cumRuns, wkts: stats.wkts, ov: stats.ov, ball: stats.balls }); }
                    let isLast = (stats.ov === match.overs - 1);
                    if (!stats.batters[h.batter]) stats.batters[h.batter] = { name: h.batter, runs: 0, balls: 0, status: 'Active' };
                    if(stats.batters[h.batter]) {
                        if(stats.batters[h.batter].status === 'DNB') stats.batters[h.batter].status = 'Active';
                        if (!isLast) stats.batters[h.batter].balls++; else if(h.legal) stats.batters[h.batter].balls++;
                        if(['normal','wicket'].includes(h.type)) stats.batters[h.batter].runs += r; else if(h.type === 'noball') { let offBat = r - 1; if(offBat > 0) stats.batters[h.batter].runs += offBat; }
                    }
                    if(stats.bowlers[h.bowler]) { stats.bowlers[h.bowler].runs += r; if(h.wkt) stats.bowlers[h.bowler].wkts++; if (!isLast) stats.bowlers[h.bowler].balls++; else if (h.legal) stats.bowlers[h.bowler].balls++; }
                    phys++; let end = false;
                    if (!isLast) { stats.balls++; if(stats.balls>=6) end=true; } else { if(h.legal) stats.balls++; if(stats.balls>=6 || phys>=8) end=true; }
                    if(end) { 
                        if (isLast && phys >= 8 && stats.balls < 6) { let diff = 6 - stats.balls; if(stats.bowlers[h.bowler]) stats.bowlers[h.bowler].balls += diff; stats.balls = 6; }
                        stats.runRateData.push({ over: stats.ov + 1, runs: overRuns, cum: cumRuns, wkts: stats.fow.filter(f => f.ov === stats.ov).length }); stats.ov++; stats.balls=0; phys=0; overRuns = 0; 
                    }
                });
                if(stats.balls > 0 || phys > 0) stats.runRateData.push({ over: stats.ov + 1, runs: overRuns, cum: cumRuns, wkts: 0 });
                return stats;
            }
            const i1 = getInningsStats(1); const i2 = getInningsStats(2);
            let resText = "Match In Progress";
            if (i1.score > i2.score && (i2.ov >= match.overs || i2.wkts >= match.count2 - 1)) resText = `${match.t1[0]}'s Team won by ${i1.score - i2.score} Runs`;
            else if (i2.score > i1.score) resText = `${match.t2[0]}'s Team won by ${Math.max(1, (match.t2.length - 1) - i2.wkts)} Wickets`;
            else if (i1.score === i2.score && i2.ov >= match.overs) resText = "Match Tied";

            let maxOver = Math.max(i1.runRateData.length, i2.runRateData.length);
            let manhattanHTML = `<div class="bar-chart">`;
            for(let o=0; o<maxOver; o++) {
                const r1 = i1.runRateData[o] ? i1.runRateData[o].runs : 0; const r2 = i2.runRateData[o] ? i2.runRateData[o].runs : 0;
                let maxR = Math.max(10, ...i1.runRateData.map(d=>d.runs), ...i2.runRateData.map(d=>d.runs));
                let h1 = (r1 / maxR) * 100; let h2 = (r2 / maxR) * 100;
                manhattanHTML += `<div class="bar-group"><div class="bar" style="height:${h1}%; background:var(--inn1-color);" data-val="${r1}"></div><div class="bar" style="height:${h2}%; background:var(--inn2-color);" data-val="${r2}"></div></div>`;
            }
            manhattanHTML += `</div>`;
            let html = `
            <div class="result-banner">${resText}</div><div class="chart-container no-print"><h4>Manhattan</h4>${manhattanHTML}</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
                <div class="report-section"><div class="report-header">Innings 1: ${i1.score}/${i1.wkts}</div><table><thead><tr><th>Batter</th><th>R</th><th>B</th></tr></thead><tbody>${Object.values(i1.batters).map(b => `<tr><td>${b.name}</td><td>${b.runs}</td><td>${b.balls}</td></tr>`).join('')}</tbody></table><h5 style="margin-top:10px">Bowling</h5><table><thead><tr><th>Bowler</th><th>O</th><th>R</th><th>W</th></tr></thead><tbody>${Object.values(i1.bowlers).filter(b=>b.balls>0).map(b => `<tr><td>${b.name}</td><td>${Math.floor(b.balls/6)}.${b.balls%6}</td><td>${b.runs}</td><td>${b.wkts}</td></tr>`).join('')}</tbody></table></div>
                <div class="report-section"><div class="report-header">Innings 2: ${i2.score}/${i2.wkts}</div><table><thead><tr><th>Batter</th><th>R</th><th>B</th></tr></thead><tbody>${Object.values(i2.batters).map(b => `<tr><td>${b.name}</td><td>${b.runs}</td><td>${b.balls}</td></tr>`).join('')}</tbody></table><h5 style="margin-top:10px">Bowling</h5><table><thead><tr><th>Bowler</th><th>O</th><th>R</th><th>W</th></tr></thead><tbody>${Object.values(i2.bowlers).filter(b=>b.balls>0).map(b => `<tr><td>${b.name}</td><td>${Math.floor(b.balls/6)}.${b.balls%6}</td><td>${b.runs}</td><td>${b.wkts}</td></tr>`).join('')}</tbody></table></div>
            </div>
            <div style="margin-top:20px;"><h4>Full Ball Logs</h4><div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
            <div class="report-section"><h5>Innings 1</h5><div class="log-container">${i1.history.map((h,i)=> `<div>${i+1}. ${h.bowler} to ${h.batter}: ${h.runs} ${h.type} ${h.wkt ? '<b style="color:red">WICKET</b>' : ''}</div>`).join('')}</div></div>
            <div class="report-section"><h5>Innings 2</h5><div class="log-container">${i2.history.map((h,i)=> `<div>${i+1}. ${h.bowler} to ${h.batter}: ${h.runs} ${h.type} ${h.wkt ? '<b style="color:red">WICKET</b>' : ''}</div>`).join('')}</div></div>
            </div></div>`;
            document.getElementById('report-content').innerHTML = html;
            document.getElementById('report-modal').style.display = 'flex';
        }

        function openTeamManager() { document.getElementById('edit-team1-list').value = match.t1.join('\n'); document.getElementById('edit-team2-list').value = match.t2.join('\n'); document.getElementById('team-manager-modal').style.display = 'flex'; }
        function confirmTeamEdit() { const newT1 = document.getElementById('edit-team1-list').value.split('\n').map(n => n.trim()).filter(n => n); const newT2 = document.getElementById('edit-team2-list').value.split('\n').map(n => n.trim()).filter(n => n); const oldT1 = match.t1; for(let i=0; i<Math.max(oldT1.length, newT1.length); i++) { if(oldT1[i] && newT1[i] && oldT1[i] !== newT1[i]) renamePlayer(oldT1[i], newT1[i], 1); } const oldT2 = match.t2; for(let i=0; i<Math.max(oldT2.length, newT2.length); i++) { if(oldT2[i] && newT2[i] && oldT2[i] !== newT2[i]) renamePlayer(oldT2[i], newT2[i], 2); } match.t1 = newT1; match.t2 = newT2; closeModals(); recalc(); }
        function renamePlayer(oldName, newName, teamId) { live.history.forEach(h => { const isInn1 = (h.innings === 1) || (!h.innings && match.innings === 1); const isInn2 = (h.innings === 2) || (!h.innings && match.innings === 2); if (teamId === 1) { if (isInn1 && h.batter === oldName) h.batter = newName; if (isInn2 && h.bowler === oldName) h.bowler = newName; if (isInn1 && h.name === oldName) h.name = newName; } else { if (isInn1 && h.bowler === oldName) h.bowler = newName; if (isInn2 && h.batter === oldName) h.batter = newName; if (isInn2 && h.name === oldName) h.name = newName; } if (h.wkt) { if (h.wkt.outPlayer === oldName && ((teamId===1 && isInn1) || (teamId===2 && isInn2))) h.wkt.outPlayer = newName; if (h.wkt.fielder === oldName && ((teamId===1 && isInn2) || (teamId===2 && isInn1))) h.wkt.fielder = newName; } }); if (live.striker === oldName) live.striker = newName; if (live.ns === oldName) live.ns = newName; if (live.bowler === oldName) live.bowler = newName; }
        function openEditModal(idx) { 
            const h = live.history[idx]; 
            if (h.event === 'new_bat' || h.event === 'replace' || h.event === 'retire') { document.getElementById('edit-event-index').value = idx; const pool = match.innings === 1 ? match.t1 : match.t2; const sel = document.getElementById('edit-event-name'); sel.innerHTML = pool.map(n => `<option value="${n}" ${n===h.name?'selected':''}>${n}</option>`).join(''); document.getElementById('edit-event-modal').style.display = 'flex'; return; } 
            
            // POPULATE EDIT FIELDS FOR BALL
            document.getElementById('edit-index').value = idx; 
            document.getElementById('edit-runs').value = h.runs; 
            document.getElementById('edit-type').value = h.type === 'wicket' ? 'wicket' : h.type; // Normalize wicket type
            
            // Toggle wicket specific fields
            const wktFields = document.getElementById('edit-wkt-fields');
            if (h.wkt || h.type === 'wicket') {
                wktFields.style.display = 'block';
                // Populate wicket fields if they exist
                if(h.wkt) {
                    document.getElementById('edit-wkt-type').value = h.wkt.type;
                    const batterList = match.innings === 1 ? match.t1 : match.t2;
                    const outSel = document.getElementById('edit-wkt-out');
                    outSel.innerHTML = batterList.map(n => `<option value="${n}" ${n===h.wkt.outPlayer?'selected':''}>${n}</option>`).join('');
                }
            } else {
                wktFields.style.display = 'none';
            }

            const batPool = match.innings === 1 ? match.t1 : match.t2; const batSel = document.getElementById('edit-batter'); batSel.innerHTML = batPool.map(n => `<option value="${n}" ${n===h.batter?'selected':''}>${n}</option>`).join('');
            const bowlPool = match.innings === 1 ? match.t2 : match.t1; const bowlSel = document.getElementById('edit-bowler'); bowlSel.innerHTML = bowlPool.map(n => `<option value="${n}" ${n===h.bowler?'selected':''}>${n}</option>`).join('');
            document.getElementById('edit-history-modal').style.display = 'flex'; 
        }
        
        function confirmEditEvent() { const idx = document.getElementById('edit-event-index').value; live.history[idx].name = document.getElementById('edit-event-name').value; closeModals(); recalc(); }
        
        function confirmEditBall() { 
            const idx = document.getElementById('edit-index').value; 
            const type = document.getElementById('edit-type').value;
            
            live.history[idx].runs = parseInt(document.getElementById('edit-runs').value); 
            live.history[idx].type = type;
            live.history[idx].batter = document.getElementById('edit-batter').value; 
            live.history[idx].bowler = document.getElementById('edit-bowler').value; 
            live.history[idx].legal = ['normal','wicket','byes','legbye'].includes(type); 
            
            // Handle Wicket Editing
            if (type === 'wicket') {
                if (!live.history[idx].wkt) live.history[idx].wkt = {}; // Create if missing
                live.history[idx].wkt.type = document.getElementById('edit-wkt-type').value;
                live.history[idx].wkt.outPlayer = document.getElementById('edit-wkt-out').value;
            }
            
            closeModals(); recalc(); 
        }
        
        function openBowlerModal() { const sel = document.getElementById('sel-bowler'); const list = match.innings === 1 ? match.t2 : match.t1; sel.innerHTML = list.map(n => `<option value="${n}" ${n===live.bowler?'selected':''}>${n}</option>`).join(''); document.getElementById('bowler-modal').style.display = 'flex'; }
        function confirmBowler() { const newBowler = document.getElementById('sel-bowler').value; live.history.push({ event: 'new_over', name: newBowler }); closeModals(); recalc(); }
        
        function getNextBatters() { return Object.values(live.batters).sort((a,b) => { const score = (s) => { if (s === 'Yet to bat') return 0; if (s === 'Retired') return 1; return 2; }; return score(a.status) - score(b.status) || a.order - b.order; }); }
        
        function openNextBatterModal() { const sel = document.getElementById('sel-next-bat-fix'); const avail = getNextBatters(); sel.innerHTML = avail.map(p => { const label = `${p.name} [${p.status}]`; return `<option value="${p.name}">${label}</option>`; }).join(''); document.getElementById('next-batter-modal').style.display = 'flex'; }
        function confirmNextBatterFix() { const next = document.getElementById('sel-next-bat-fix').value; live.history.push({ event: 'new_bat', name: next }); closeModals(); recalc(); }

        function openWicketModal() { const sel = document.getElementById('sel-next-bat'); const avail = getNextBatters(); sel.innerHTML = avail.map(p => { const label = `${p.name} [${p.status}]`; return `<option value="${p.name}">${label}</option>`; }).join(''); const fSel = document.getElementById('wkt-fielder'); const fieldTeam = match.innings === 1 ? match.t2 : match.t1; fSel.innerHTML = `<option value="">-- None/Bowler --</option>` + fieldTeam.map(n => `<option value="${n}">${n}</option>`).join(''); document.getElementById('wicket-modal').style.display = 'flex'; }
        function confirmWicket() { 
            const who = document.getElementById('wkt-who').value; 
            const next = document.getElementById('sel-next-bat').value; 
            const type = document.getElementById('wkt-type').value; 
            const runs = parseInt(document.getElementById('wkt-runs').value) || 0;
            const fielder = document.getElementById('wkt-fielder').value; 
            const outName = (who === 'striker') ? live.striker : live.ns; 
            
            live.batters[outName].status = 'Out'; 
            handleBall(runs, 'wicket', { type, outPlayer: outName, fielder }); 
            live.history.push({ event: 'new_bat', name: next }); 
            closeModals(); recalc(); 
        }
        function openRetireModal() { const sel = document.getElementById('sel-retire-next'); const avail = getNextBatters(); sel.innerHTML = avail.map(p => { const label = `${p.name} [${p.status}]`; return `<option value="${p.name}">${label}</option>`; }).join(''); document.getElementById('retire-modal').style.display = 'flex'; }
        function confirmRetire() { const next = document.getElementById('sel-retire-next').value; live.batters[live.striker].status = 'Retired'; live.history.push({ event: 'retire', name: live.striker }); live.history.push({ event: 'new_bat', name: next }); closeModals(); recalc(); }
        function openManualSwap(role) { const sel = document.getElementById('sel-swap'); const pool = (role === 'bowler') ? (match.innings === 1 ? match.t2 : match.t1) : (match.innings === 1 ? match.t1 : match.t2); sel.innerHTML = pool.map(n => `<option value="${n}">${n}</option>`).join(''); document.getElementById('swap-role').value = role; document.getElementById('swap-modal').style.display = 'flex'; }
        function confirmSwap() { const role = document.getElementById('swap-role').value; const name = document.getElementById('sel-swap').value; if (role === 'striker' && name === live.striker) return closeModals(); if (role === 'ns' && name === live.ns) return closeModals(); if ((role === 'striker' && name === live.ns) || (role === 'ns' && name === live.striker)) return manualSwapStrike(); live.history.push({ event: 'replace', role, name }); closeModals(); recalc(); }
        function checkRetire(b) { if (!b || b.status !== 'Active') return; const active = Object.values(live.batters).filter(p => p.status === 'Active' || p.status === 'Yet to bat').length; if (active <= 2 || !b || b.balls === 0) return; if (b.stint === 1 && b.balls >= live.retireLimit) { setTimeout(() => { alert(b.name + " reached limit. Retire?"); }, 500); } if (b.stint === 2 && b.returnLimit !== null && live.ov >= b.returnLimit && live.balls === 0) { setTimeout(() => { alert(b.name + " return stint done. Retire?"); }, 500); } }
        function manualSwapStrike() { live.history.push({ event: 'swap' }); closeModals(); recalc(); }
        function undo() { live.history.pop(); recalc(); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function selectZone(z) { for(let i=live.history.length-1; i>=0; i--) { if(live.history[i].event === 'ball') { live.history[i].zone = z; break; } } closeModals(); recalc(); }
        function openFieldModal() { document.getElementById('field-modal').style.display = 'flex'; }
        function swapInnings() { match.target = live.runs + 1; match.innings = 2; document.getElementById('innings-notice').style.display = 'block'; document.getElementById('innings-notice').innerText = "Target: " + match.target; document.getElementById('bat-list').value = match.t1.join('\n'); document.getElementById('bowl-list').value = match.t2.join('\n'); const oldB = document.getElementById('bat-list').value; document.getElementById('bat-list').value = document.getElementById('bowl-list').value; document.getElementById('bowl-list').value = oldB; document.getElementById('scoring-screen').style.display = 'none'; document.getElementById('setup-screen').style.display = 'block'; }
        function exportState() { const blob = new Blob([JSON.stringify({match, live})], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'match.json'; a.click(); }
        function importState(e) { const reader = new FileReader(); reader.onload = (ev) => { const d = JSON.parse(ev.target.result); match = d.match; live = d.live; document.getElementById('setup-screen').style.display='none'; document.getElementById('scoring-screen').style.display='grid'; recalc(); }; reader.readAsText(e.target.files[0]); }
        function resetMatch() { if (confirm("Wipe?")) { localStorage.removeItem('pumas_save'); location.reload(); } }
        function saveMatch() { localStorage.setItem('pumas_save', JSON.stringify({ match, live })); alert("Match Saved Successfully!"); }
        function saveToMemory() { localStorage.setItem('pumas_save', JSON.stringify({ match, live })); const ind = document.getElementById('save-indicator'); ind.style.opacity = 1; setTimeout(() => ind.style.opacity = 0, 2000); }
        window.onload = () => { const s = localStorage.getItem('pumas_save'); if (s && confirm("Resume Match?")) { const d = JSON.parse(s); match = d.match; live = d.live; document.getElementById('setup-screen').style.display = 'none'; document.getElementById('scoring-screen').style.display = 'grid'; recalc(); } };
    </script>
</body>
</html>